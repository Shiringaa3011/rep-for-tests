name: CI/CD Pipeline with Approvals

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # –°–¢–ê–î–ò–Ø 1: –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –ü–†–û–í–ï–†–ö–ò
  validation:
    name: "‚úÖ Validation & Checks"
    runs-on: ubuntu-latest
    
    steps:
    - name: "üì• Checkout code"
      uses: actions/checkout@v4
    
    - name: "üîç Validate Markdown syntax"
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Markdown —Ñ–∞–π–ª–æ–≤..."
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ .md —Ñ–∞–π–ª—ã —á–∏—Ç–∞–µ–º—ã
        find docs/ -name "*.md" -exec echo "‚úì {}" \;
        find content/ -name "*.md" -exec echo "‚úì {}" \;
        echo "‚úÖ –í—Å–µ Markdown —Ñ–∞–π–ª—ã –≤–∞–ª–∏–¥–Ω—ã"
    
    - name: "üìÅ Validate project structure"
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞..."
        [ -d "docs/" ] || exit 1
        [ -d "content/" ] || exit 1
        [ -f "docs/CONTRIBUTING.md" ] || exit 1
        [ -f "README.md" ] || exit 1
        echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
    
    - name: "üìä Check file statistics"
      run: |
        echo "=== –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ ==="
        echo "Docs files: $(find docs/ -name "*.md" | wc -l)"
        echo "Content files: $(find content/ -name "*.md" -o -name "*.txt" | wc -l)"
        echo "Total lines in questionnaire: $(find content/ -name "*questionnaire*" -exec cat {} \; | wc -l)"

  # –°–¢–ê–î–ò–Ø 2: –°–ë–û–†–ö–ê –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò (—Ç–æ–ª—å–∫–æ –¥–ª—è main)
  build-pages:
    name: "üåê Build GitHub Pages"
    runs-on: ubuntu-latest
    needs: validation
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: "üì• Checkout code"
      uses: actions/checkout@v4
    
    - name: "üöÄ Setup Pages"
      uses: actions/configure-pages@v3
    
    - name: "üìö Build documentation site"
      run: |
        echo "–°–±–æ—Ä–∫–∞ —Å–∞–π—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏..."
        mkdir -p _site
        
        # –°–æ–∑–¥–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        cat > _site/index.html << EOF
        <!DOCTYPE html>
        <html>
        <head>
            <title>Project Documentation</title>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .section { margin: 20px 0; padding: 15px; border-left: 4px solid #0366d6; }
            </style>
        </head>
        <body>
            <h1>üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞</h1>
            <div class="section">
                <h2>üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è</h2>
                <ul>
                    <li><a href="docs/">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</a></li>
                    <li><a href="content/">–†–∞–±–æ—á–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</a></li>
                </ul>
            </div>
            <div class="section">
                <h2>üîó –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏</h2>
                <ul>
                    <li><a href="https://github.com/${{ github.repository }}">GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</a></li>
                    <li><a href="docs/CONTRIBUTING.md">–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≤–∫–ª–∞–¥—É</a></li>
                </ul>
            </div>
            <p><em>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: $(date)</em></p>
        </body>
        </html>
        EOF
        
        # –ö–æ–ø–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
        cp -r docs/ _site/docs/ || true
        cp -r content/ _site/content/ || true
        
        echo "‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–±—Ä–∞–Ω–∞"
    
    - name: "üì§ Upload artifact"
      uses: actions/upload-pages-artifact@v2
      with:
        path: _site

  # –°–¢–ê–î–ò–Ø 3: –î–ï–ü–õ–û–ô PAGES (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
  deploy-pages:
    name: "üéØ Deploy to GitHub Pages"
    runs-on: ubuntu-latest
    needs: build-pages
    if: github.ref == 'refs/heads/main'
    
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: "üöÄ Deploy to GitHub Pages"
      id: deployment
      uses: actions/deploy-pages@v2
