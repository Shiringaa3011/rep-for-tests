name: Check dynamic approvals (N-1 rule)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted, dismissed, edited]

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read

    steps:
      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y jq gh

      - name: Check approvals dynamically
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.number }}
        run: |
          set -euo pipefail

          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ø—Ä—É–≤–æ–≤ –¥–ª—è PR #$PR_NUMBER –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ $REPO"
          OWNER="${REPO%/*}"

          # 1Ô∏è‚É£ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤—Ç–æ—Ä–∞ PR
          PR_AUTHOR=$(gh api repos/$REPO/pulls/$PR_NUMBER --jq '.user.login')
          echo "–ê–≤—Ç–æ—Ä PR: $PR_AUTHOR"

          # 2Ô∏è‚É£ –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
          if gh api orgs/$OWNER >/dev/null 2>&1; then
            echo "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è $OWNER –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–¥—Å—á—ë—Ç —á–ª–µ–Ω–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏..."
            TOTAL_MEMBERS=$(gh api orgs/$OWNER/members --paginate --jq '.[].login' | wc -l | tr -d ' ')
          else
            echo "–í–ª–∞–¥–µ–ª–µ—Ü $OWNER ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. –ü–æ–¥—Å—á—ë—Ç –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
            TOTAL_MEMBERS=$(gh api repos/$REPO/collaborators --paginate --jq '.[].login' | wc -l | tr -d ' ')
          fi

          echo "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã (N): $TOTAL_MEMBERS"

          if [ "$TOTAL_MEMBERS" -le 1 ]; then
            echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω —Ç–æ–ª—å–∫–æ 1 —É—á–∞—Å—Ç–Ω–∏–∫ ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ N-1 –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
            exit 0
          fi

          REQUIRED=$((TOTAL_MEMBERS - 1))
          echo "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–ø—Ä—É–≤–æ–≤ (N-1): $REQUIRED"

          # 3Ô∏è‚É£ –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–≤—å—é PR
          REVIEWS=$(gh api repos/$REPO/pulls/$PR_NUMBER/reviews --jq '[.[] | select(.state=="APPROVED") | .user.login] | unique')
          echo "–†–µ–≤—å—é–µ—Ä—ã —Å APPROVED:"
          echo "$REVIEWS" | jq '.'

          # 4Ô∏è‚É£ –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–ø—Ä—É–≤–µ—Ä–æ–≤ (–∏—Å–∫–ª—é—á–∞—è –∞–≤—Ç–æ—Ä–∞ PR)
          APPROVALS=$(echo "$REVIEWS" | jq '[.[] | select(. != "'"$PR_AUTHOR"'")] | length')
          echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–ø—Ä—É–≤–æ–≤ (–±–µ–∑ –∞–≤—Ç–æ—Ä–∞): $APPROVALS"

          # 5Ô∏è‚É£ –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º
          if [ "$APPROVALS" -lt "$REQUIRED" ]; then
            echo "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ø—Ä—É–≤–æ–≤ ($APPROVALS / $REQUIRED). Merge –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º."
            exit 1
          fi

          echo "‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ø—Ä—É–≤–æ–≤ ($APPROVALS / $REQUIRED). –ú–æ–∂–Ω–æ –º–µ—Ä–∂–∏—Ç—å."
